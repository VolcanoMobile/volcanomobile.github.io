/* Copyright (C) Volcanomobile, Inc - All Rights Reserved
 * Unauthorized copying of this file, via any medium is strictly prohibited
 * Proprietary and confidential
 * Written by Volcanomobile <contact@volcanomobile.net>, January 2020
 */ 

 var myMidiClock,myMidiClockPlayer,myMidiAccessApi;function devicesChanged(e){listMidiInputDevices(e.midiAccess),listMidiOutputDevices(e.midiAccess)}function listMidiInputDevices(e){var i=jQuery("#midiInputs");if(i.html(""),null!=e.inputs)for(var n of e.inputs.values()){var t="";t+=(n.onmidimessage?"<span class='fa fa-check text-success'></span>":"<span class='fa fa-plug'></span>")+" ",t+=n.name,i.append(jQuery("<button/>",{inputPortName:n.name,portConnected:n.onmidimessage?1:0,class:"list-group-item  list-group-item-action"}).append(jQuery("<div/>",{}).html(t)).click(function(){var e=jQuery(this).attr("inputPortName");parseInt(jQuery(this).attr("portConnected"))?myMidiAccessApi.unbindInputPortByName(e):myMidiAccessApi.bindInputPortByName(e)}))}}function listMidiOutputDevices(e){var i=jQuery("#midiOutputs");if(i.html(""),null!=e.outputs)for(var n of e.outputs){var t=n[1],o="";o+=(myMidiAccessApi.isOutputConnectedById(t.id)?"<span class='fa fa-check text-success'></span>":"<span class='fa fa-plug'></span>")+" ",o+=t.name,o+=" <small>("+t.id+")</small>",i.append(jQuery("<button/>",{class:"list-group-item list-group-item-action",outputPortName:t.name,portConnected:myMidiAccessApi.isOutputConnectedById(t.id)?1:0}).html(o).click(function(){var e=jQuery(this).attr("outputPortName");parseInt(jQuery(this).attr("portConnected"))?myMidiAccessApi.disconnectOutputPortByName(e):myMidiAccessApi.connectOutputPortByName(e)}))}}function refreshTimeSignatureInfo(e,i){$("#clockTimeSignature").html(e+"/"+i)}function refreshNumberOfBarInfo(e){$("#clockNumberOfBars").html(e)}function refreshDivisionInfo(e){$("#clockDivision").html(e)}function refreshBpmInfo(e){jQuery("#bpmValue").html(e+" BPM")}function logText(e){jQuery("#inputLog").html(e)}function logMidiInputEventArray(e){var i="";for(var n in e){var t=e[n],o=0;for(var c in t){var r=t[c];i+=(o>0?", ":"")+c+": "+(r="number"==typeof r?(r+"").padStart(3,"0"):r.padEnd(14,".")+""),o++}}jQuery("#inputLog").prepend(i+"<br/>"),jQuery("#inputLog").html(jQuery("#inputLog").html().substring(0,2e3))}jQuery(document).ready(function(){myMidiClock=new jMidiClock({onInit:function(e){refreshTimeSignatureInfo(e.numerator,e.denominator),refreshNumberOfBarInfo(e.numberOfBars),refreshDivisionInfo(e.division),$("#numeratorSelect").val(e.numerator),$("#denominatorSelect").val(e.denominator),$("#numberOfBarSelect").val(e.numberOfBars),$("#divisionSelect").val(e.division)},onStartTempo:function(){jQuery("#buttonStart").css("display","none"),jQuery("#buttonContinue").css("display","none"),jQuery("#buttonStop").css("display","")},onStartTempoClock:function(e){if(e.patternClockCpt%e.beatLenghtInTick==0){myMidiAccessApi.send({receivedTime:window.performance.now(),data:[153,34,100]}),jQuery("#startTempoLight").fadeIn(0).fadeOut(200,function(){});var i=100*(e.patternClockCpt+e.beatLenghtInTick)/e.barLenghtInTick;$("#measureProgressBar").css("width",i+"%").attr("aria-valuenow",i)}},onStart:function(e){myMidiAccessApi.send({receivedTime:window.performance.now(),data:[250]}),jQuery("#buttonStart").css("display","none"),jQuery("#buttonContinue").css("display","none"),jQuery("#buttonStop").css("display","")},onContinue:function(){myMidiAccessApi.send({receivedTime:window.performance.now(),data:[251]}),jQuery("#buttonStart").css("display","none"),jQuery("#buttonContinue").css("display","none"),jQuery("#buttonStop").css("display","")},onStop:function(){myMidiAccessApi.send({receivedTime:window.performance.now(),data:[252]}),jQuery("#buttonStart").css("display",""),jQuery("#buttonContinue").css("display",""),jQuery("#buttonStop").css("display","none")},onClock:function(e){$("#patternClockCounter").html(e.patternClockCpt+"/"+e.patternLenghtInTick),$("#barClockCounter").html(e.barClockCpt+"/"+e.barLenghtInTick),$("#beatClockCounter").html(e.beatClockCpt+"/"+e.beatLenghtInTick),$("#divisionClockCounter").html(e.divisionClockCpt+"/"+e.divisionLenghtInTick),myMidiAccessApi.send({receivedTime:window.performance.now(),data:[248]});var i=100*e.patternClockCpt/e.patternLenghtInTick;$("#measureProgressBar").css("width",i+"%").attr("aria-valuenow",i),0==e.beatClockCpt&&(jQuery("#metronomeCheckbox").is(":checked")&&myMidiAccessApi.send({receivedTime:window.performance.now(),data:[153,36,100]}),jQuery("#beatLight").fadeIn(0).fadeOut(40,function(){})),0==e.divisionClockCpt&&(jQuery("#divisionCheckbox").is(":checked")&&myMidiAccessApi.send({receivedTime:window.performance.now(),data:[153,42,100]}),jQuery("#divisionLight").fadeIn(0).fadeOut(40,function(){})),0==e.patternClockCpt&&(myMidiClock.setDenominator($("#denominatorSelect").val()),myMidiClock.setNumerator($("#numeratorSelect").val()),myMidiClock.setNumberOfBars($("#numberOfBarSelect").val()),myMidiClock.setDivision($("#divisionSelect").val()))},onTimeSignatureChange:function(e,i){refreshTimeSignatureInfo(e,i)},onNumberOfBarsChange:function(e){refreshNumberOfBarInfo(e)},onDivisionChange:function(e){refreshDivisionInfo(e)}}),myMidiClockPlayer=new jMidiClockPlayer({onInit:function(e){refreshBpmInfo(e.bpm)},onClock:function(e){myMidiClock.clock()},onStart:function(e){myMidiClock.start(e)},onContinue:function(e){myMidiClock.continue_()},onStop:function(e){myMidiClock.stop()},onBpmChange:function(e){refreshBpmInfo(e)}}),myMidiAccessApi=new jMidiAccessApi({logLevel : jMidiAccessApi.LOG_LEVEL_ALL, initCallback:function(e){jQuery("#midiNotSupported").css("display",e.midiSupported?"none":"block"),e.midiSupported&&devicesChanged(e)},deviceStateChangeCallback:function(e,i){devicesChanged(i)},portConnectedCallback:function(e,i){devicesChanged(i)},portDisconnectedCallback:function(e,i){devicesChanged(i)},receiveCallback:function(e){var i=MIDIMessageEventParser.parseEvent(e);for(eventIndex in i){var n=i[eventIndex];"clock"==n.type?myMidiClockPlayer.clock(!0):"start"==n.type?myMidiClockPlayer.start(!0):"continue"==n.type?myMidiClockPlayer.continue_(!0):"stop"==n.type?myMidiClockPlayer.stop(!0):myMidiAccessApi.send(e)}}}),jQuery("#buttonStart").click(function(){myMidiClockPlayer.start()}),jQuery("#buttonContinue").click(function(){myMidiClockPlayer.continue_()}),jQuery("#buttonStop").click(function(){myMidiClockPlayer.stop()}),$("#divisionSelect").on("change",function(){myMidiClock.setDivision($(this).val())}),jQuery("#bpmRange").on("input",function(){jQuery(this).trigger("change")}),jQuery("#bpmRange").change(function(){myMidiClockPlayer.setBpm(2*jQuery(this).val())}),jQuery("#startTempoCheckbox").change(function(){myMidiClock.setStartTempo(this.checked)}),jQuery("#infoButton").click(function(){jQuery("#infoPanel").slideToggle()}),jQuery("#showInfoPanelButton").click(function(){jQuery("#infoPanel").slideToggle()}),jQuery("#hideInfoPanelButton").click(function(){jQuery("#infoPanel").slideToggle()}),jQuery("#midiPanelButton").click(function(){jQuery("#midiPanel").slideToggle()}),jQuery("#hideMidiPanelButton").click(function(){jQuery("#midiPanel").slideToggle()}),$(window).keypress(function(e){32===e.which?myMidiClock.isStarted()?myMidiClockPlayer.stop():myMidiClockPlayer.continue_():13===e.which?myMidiClock.isStarted()?myMidiClockPlayer.stop():myMidiClockPlayer.start():43===e.which?myMidiClockPlayer.setBpm(myMidiClockPlayer.getBpm()+1):45===e.which?myMidiClockPlayer.setBpm(myMidiClockPlayer.getBpm()-1):109===e.which?$("#metronomeCheckbox").click():100===e.which&&$("#divisionCheckbox").click()})}),jQuery(document).ready(function(){jQuery("#inputLog").click(function(){jQuery(this).html("")})});